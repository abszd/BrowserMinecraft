(function(){"use strict";class N{constructor(){this.TRANSPARENT_BLOCKS=new Set([-1,4,5]),this.blockTable=null,this.idBlockTypeLookup={},this.waterInset=.2}initialize(u,S,t){this.blockTable=u,this.atlasUVs=t,this.TRANSPARENT_BLOCKS=new Set(S),this.idBlockTypeLookup={},Object.entries(u).forEach(([i,c])=>{this.idBlockTypeLookup[c.guid]=i})}createGreedyMesh(u){const{grid:S,size:t,height:i,chunkX:c,chunkZ:r}=u,p=c*t,m=r*t;let o=[];const s=new Map(S);for(let e=0;e<t;e++){const l=i*t;let g=new Int8Array(l),A=new Int8Array(l),$=new Int8Array(l),k=new Int8Array(l),T=!1;for(let a=0;a<i;a++)for(let h=0;h<t;h++){let n=s.get(`${e} ${a} ${h}`);const R=a*t+h;if(n!==void 0){T=!0;let b=e===t-1?n===5?0:-1:s.get(`${e+1} ${a} ${h}`)??-1;this.TRANSPARENT_BLOCKS.has(b)&&n!==b&&(g[R]=n+1),b=e===0?n===5?0:-1:s.get(`${e-1} ${a} ${h}`)??-1,this.TRANSPARENT_BLOCKS.has(b)&&n!==b&&(A[R]=n+1)}if(n=s.get(`${h} ${a} ${e}`),n!==void 0){T=!0;let b=e===t-1?n===5?0:-1:s.get(`${h} ${a} ${e+1}`)??-1;this.TRANSPARENT_BLOCKS.has(b)&&n!==b&&($[R]=n+1),b=e===0?n===5?0:-1:s.get(`${h} ${a} ${e-1}`)??-1,this.TRANSPARENT_BLOCKS.has(b)&&n!==b&&(k[R]=n+1)}}T&&(o.push(...this.getGreedySlice(g,i,t,0,e,0,p,m)),o.push(...this.getGreedySlice(A,i,t,0,e,1,p,m)),o.push(...this.getGreedySlice($,i,t,2,e,0,p,m)),o.push(...this.getGreedySlice(k,i,t,2,e,1,p,m)))}for(let e=0;e<i;e++){let l=new Int8Array(t*t),g=new Int8Array(t*t),A=!1;for(let $=0;$<t;$++)for(let k=0;k<t;k++){const T=$*t+k,a=s.get(`${$} ${e} ${k}`);if(a!==void 0){A=!0;let h=s.get(`${$} ${e+1} ${k}`)??-1;this.TRANSPARENT_BLOCKS.has(h)&&a!==h&&(l[T]=a+1),h=s.get(`${$} ${e-1} ${k}`)??-1,this.TRANSPARENT_BLOCKS.has(h)&&a!==h&&(g[T]=a+1)}}A&&(o.push(...this.getGreedySlice(l,t,t,1,e,0,p,m)),o.push(...this.getGreedySlice(g,t,t,1,e,1,p,m)))}return this.makeGreedyMeshData(o)}getGreedySlice(u,S,t,i,c,r,p=0,m=0){const o=[];for(let s=0;s<S;s++)for(let e=0;e<t;e++){const l=u[s*t+e];if(l<=0)continue;let g=e,A=e,$=s,k=s;for(;++A<t&&u[s*t+A]===l;);for(;++k<S;){let a=!0;for(let h=g;h<A;h++)if(u[k*t+h]!==l){a=!1;break}if(!a)break}const T=this.idBlockTypeLookup[l-1];if(T!==void 0){o.push(this.createRect(T,t,g,A,$,k,i,c,r,p,m));for(let a=$;a<k;a++)for(let h=g;h<A;h++)u[a*t+h]=0}}return o}createRect(u,S,t,i,c,r,p,m,o,s=0,e=0){let l,g,A;const $=i-t,k=r-c-(u==="water"&&o===0?this.waterInset:0);let T="side";if(p===1&&(T=o===0?"top":"bottom"),p===0){const n=s+m+1-o;l=o==1?[n,c,e+t,n,c,e+i,n,r,e+i,n,r,e+t]:[n,c,e+i,n,c,e+t,n,r,e+t,n,r,e+i],g=o===0?[1,0,0]:[-1,0,0],A=[0,0,$,0,$,k,0,k]}else if(p===1){const n=m+1-o-(u==="water"&&o===0?this.waterInset:0);l=o==1?[s+c,n,e+t,s+r,n,e+t,s+r,n,e+i,s+c,n,e+i]:[s+r,n,e+t,s+c,n,e+t,s+c,n,e+i,s+r,n,e+i],g=o===1?[0,-1,0]:[0,1,0],A=[0,0,k,0,k,$,0,$]}else{const n=e+m+1-o;l=o==0?[s+t,c,n,s+i,c,n,s+i,r,n,s+t,r,n]:[s+i,c,n,s+t,c,n,s+t,r,n,s+i,r,n],g=o===0?[0,0,1]:[0,0,-1],A=[0,0,$,0,$,k,0,k]}const a=[];for(let n=0;n<4;n++)a.push(...g);const h=`${u}-${T}`;return{vertices:l,normals:a,uvs:A,blockType:u,face:T,meshKey:h}}makeGreedyMeshData(u){if(u.length===0)return{};const S={};for(const i of u){const c=i.meshKey;c&&(S[c]||(S[c]=[]),S[c].push(i))}const t={};for(const[i,c]of Object.entries(S)){const r=[],p=[],m=[],o=[];let s=0;for(const e of c)!e.vertices||e.vertices.length!==12||!e.normals||e.normals.length!==12||!e.uvs||e.uvs.length!==8||(r.push(...e.vertices),p.push(...e.normals),m.push(...e.uvs),o.push(s,s+1,s+2,s,s+2,s+3),s+=4);r.length!==0&&(t[i]={positions:r,normals:p,uvs:m,indices:o})}return t}buildWaterMesh(u,S,t,i){if(u.length===0)return null;const c=[],r=[],p=[],m=[];let o=0;for(const s of u){const e=s.x+S*i+.5,l=s.y+.5,g=s.z+t*i+.5;s.isTopWater&&(c.push(e-.5,l+.425,g-.5,e+.5,l+.425,g-.5,e+.5,l+.425,g+.5,e-.5,l+.425,g+.5),r.push(0,1,0,0,1,0,0,1,0,0,1,0),p.push(0,0,1,0,1,1,0,1),m.push(o,o+1,o+2,o,o+2,o+3),o+=4)}return c.length===0?null:{positions:c,normals:r,uvs:p,indices:m}}}const y=new N;self.onmessage=function(M){const{type:u,frameno:S,data:t}=M.data;try{switch(u){case"initialize":y.initialize(t.blockTable,t.transparentBlocks),self.postMessage({type:"initialized",frameno:S,success:!0});break;case"buildMesh":const{chunkData:i,waterBlocks:c}=t,r=y.createGreedyMesh(i),p=c&&c.length>0?y.buildWaterMesh(c,i.chunkX,i.chunkZ,i.size):null;self.postMessage({type:"meshCompleted",data:{chunkId:`${i.chunkX},${i.chunkZ}`,terrainMeshData:r,waterMeshData:p,frameno:S}});break;default:throw new Error(`Unknown message type: ${u}`)}}catch(i){self.postMessage({type:"error",error:i.message,stack:i.stack})}}})();
