(function(){"use strict";class N{constructor(){this.TRANSPARENT_BLOCKS=new Set([-1,4,5]),this.blockTable=null,this.idBlockTypeLookup={}}initialize(l,$){this.blockTable=l,this.TRANSPARENT_BLOCKS=new Set($),this.idBlockTypeLookup={},Object.entries(l).forEach(([e,i])=>{this.idBlockTypeLookup[i.guid]=e})}createGreedyMesh(l){const{grid:$,size:e,height:i,chunkX:o,chunkZ:r}=l,m=o*e,S=r*e;let c=[];const s=new Map($);for(let t=0;t<e;t++){const u=i*e;let p=new Int8Array(u),T=new Int8Array(u),g=new Int8Array(u),k=new Int8Array(u),b=!1;for(let h=0;h<i;h++)for(let a=0;a<e;a++){let n=s.get(`${t} ${h} ${a}`);const y=h*e+a;if(n!==void 0&&n!==5){b=!0;let A=s.get(`${t+1} ${h} ${a}`)??-1;this.TRANSPARENT_BLOCKS.has(A)&&n!==A&&(p[y]=n+1),A=s.get(`${t-1} ${h} ${a}`)??-1,this.TRANSPARENT_BLOCKS.has(A)&&n!==A&&(T[y]=n+1)}if(n=s.get(`${a} ${h} ${t}`),n!==void 0&&n!==5){b=!0;let A=s.get(`${a} ${h} ${t+1}`)??-1;this.TRANSPARENT_BLOCKS.has(A)&&n!==A&&(g[y]=n+1),A=s.get(`${a} ${h} ${t-1}`)??-1,this.TRANSPARENT_BLOCKS.has(A)&&n!==A&&(k[y]=n+1)}}b&&(c.push(...this.getGreedySlice(p,i,e,0,t,0,m,S)),c.push(...this.getGreedySlice(T,i,e,0,t,1,m,S)),c.push(...this.getGreedySlice(g,i,e,2,t,0,m,S)),c.push(...this.getGreedySlice(k,i,e,2,t,1,m,S)))}for(let t=0;t<i;t++){let u=new Int8Array(e*e),p=new Int8Array(e*e),T=!1;for(let g=0;g<e;g++)for(let k=0;k<e;k++){const b=g*e+k,h=s.get(`${g} ${t} ${k}`);if(h!==void 0&&h!==5){T=!0;let a=s.get(`${g} ${t+1} ${k}`)??-1;this.TRANSPARENT_BLOCKS.has(a)&&h!==a&&(u[b]=h+1),a=s.get(`${g} ${t-1} ${k}`)??-1,this.TRANSPARENT_BLOCKS.has(a)&&h!==a&&(p[b]=h+1)}}T&&(c.push(...this.getGreedySlice(u,e,e,1,t,0,m,S)),c.push(...this.getGreedySlice(p,e,e,1,t,1,m,S)))}return this.makeGreedyMeshData(c)}getGreedySlice(l,$,e,i,o,r,m=0,S=0){const c=[];for(let s=0;s<$;s++)for(let t=0;t<e;t++){const u=l[s*e+t];if(u<=0)continue;let p=t,T=t,g=s,k=s;for(;++T<e&&l[s*e+T]===u;);for(;++k<$;){let h=!0;for(let a=p;a<T;a++)if(l[k*e+a]!==u){h=!1;break}if(!h)break}const b=this.idBlockTypeLookup[u-1];if(b!==void 0){c.push(this.createRect(b,e,p,T,g,k,i,o,r,m,S));for(let h=g;h<k;h++)for(let a=p;a<T;a++)l[h*e+a]=0}}return c}createRect(l,$,e,i,o,r,m,S,c,s=0,t=0){let u,p,T;const g=i-e,k=r-o;let b="side";if(m===1&&(b=c===0?"top":"bottom"),m===0){const n=s+S+1-c;u=c==1?[n,o,t+e,n,o,t+i,n,r,t+i,n,r,t+e]:[n,o,t+i,n,o,t+e,n,r,t+e,n,r,t+i],p=c===0?[1,0,0]:[-1,0,0],T=[0,0,g,0,g,k,0,k]}else if(m===1){const n=S+1-c;u=c==1?[s+o,n,t+e,s+r,n,t+e,s+r,n,t+i,s+o,n,t+i]:[s+r,n,t+e,s+o,n,t+e,s+o,n,t+i,s+r,n,t+i],p=c===1?[0,-1,0]:[0,1,0],T=[0,0,k,0,k,g,0,g]}else{const n=t+S+1-c;u=c==0?[s+e,o,n,s+i,o,n,s+i,r,n,s+e,r,n]:[s+i,o,n,s+e,o,n,s+e,r,n,s+i,r,n],p=c===0?[0,0,1]:[0,0,-1],T=[0,0,g,0,g,k,0,k]}const h=[];for(let n=0;n<4;n++)h.push(...p);const a=`${l}-${b}`;return{vertices:u,normals:h,uvs:T,blockType:l,face:b,meshKey:a}}makeGreedyMeshData(l){if(l.length===0)return{};const $={};for(const i of l){const o=i.meshKey;o&&($[o]||($[o]=[]),$[o].push(i))}const e={};for(const[i,o]of Object.entries($)){const r=[],m=[],S=[],c=[];let s=0;for(const t of o)!t.vertices||t.vertices.length!==12||!t.normals||t.normals.length!==12||!t.uvs||t.uvs.length!==8||(r.push(...t.vertices),m.push(...t.normals),S.push(...t.uvs),c.push(s,s+1,s+2,s,s+2,s+3),s+=4);r.length!==0&&(e[i]={positions:r,normals:m,uvs:S,indices:c})}return e}buildWaterMesh(l,$,e,i){if(l.length===0)return null;const o=[],r=[],m=[],S=[];let c=0;for(const s of l){const t=s.x+$*i+.5,u=s.y+.5,p=s.z+e*i+.5;s.isTopWater&&(o.push(t-.5,u+.425,p-.5,t+.5,u+.425,p-.5,t+.5,u+.425,p+.5,t-.5,u+.425,p+.5),r.push(0,1,0,0,1,0,0,1,0,0,1,0),m.push(0,0,1,0,1,1,0,1),S.push(c,c+1,c+2,c,c+2,c+3),c+=4)}return o.length===0?null:{positions:o,normals:r,uvs:m,indices:S}}}const R=new N;self.onmessage=function(M){const{type:l,data:$}=M.data;try{switch(l){case"initialize":R.initialize($.blockTable,$.transparentBlocks),self.postMessage({type:"initialized",success:!0});break;case"buildMesh":const{chunkData:e,waterBlocks:i}=$,o=R.createGreedyMesh(e),r=i&&i.length>0?R.buildWaterMesh(i,e.chunkX,e.chunkZ,e.size):null;self.postMessage({type:"meshCompleted",data:{chunkId:`${e.chunkX},${e.chunkZ}`,terrainMeshData:o,waterMeshData:r}});break;default:throw new Error(`Unknown message type: ${l}`)}}catch(e){self.postMessage({type:"error",error:e.message,stack:e.stack})}}})();
