(function(){"use strict";class N{constructor(){this.TRANSPARENT_BLOCKS=new Set([-1,4,5]),this.blockTable=null,this.idBlockTypeLookup={}}initialize(u,c){this.blockTable=u,this.TRANSPARENT_BLOCKS=new Set(c),this.idBlockTypeLookup={},Object.entries(u).forEach(([e,i])=>{this.idBlockTypeLookup[i.guid]=e})}getBlock(u,c,e,i){const o=`${c} ${e} ${i}`,A=u.get(o);return A===void 0?-1:A}createGreedyMesh(u){const{grid:c,size:e,height:i,chunkX:o,chunkZ:A}=u,b=o*e,k=A*e;let n=[];const s=new Map(c);for(let t=0;t<e;t++){let p=Array(i).fill().map(()=>Array(e).fill(-1)),g=Array(i).fill().map(()=>Array(e).fill(-1));for(let r=0;r<i;r++)for(let l=0;l<e;l++){const a=this.getBlock(s,t,r,l);if(a!==-1&&a!==5){let m=t===e-1?-1:this.getBlock(s,t+1,r,l);this.TRANSPARENT_BLOCKS.has(m)&&a!==m&&(p[r][l]=a),m=t===0?-1:this.getBlock(s,t-1,r,l),this.TRANSPARENT_BLOCKS.has(m)&&a!==m&&(g[r][l]=a)}}n.push(...this.getGreedySlice(p,0,t,0,b,k)),n.push(...this.getGreedySlice(g,0,t,1,b,k))}for(let t=0;t<e;t++){let p=Array(i).fill().map(()=>Array(e).fill(-1)),g=Array(i).fill().map(()=>Array(e).fill(-1));for(let r=0;r<i;r++)for(let l=0;l<e;l++){const a=this.getBlock(s,l,r,t);if(a!==-1&&a!==5){let m=t===e-1?-1:this.getBlock(s,l,r,t+1);this.TRANSPARENT_BLOCKS.has(m)&&a!==m&&(p[r][l]=a),m=t===0?-1:this.getBlock(s,l,r,t-1),this.TRANSPARENT_BLOCKS.has(m)&&a!==m&&(g[r][l]=a)}}n.push(...this.getGreedySlice(p,2,t,0,b,k)),n.push(...this.getGreedySlice(g,2,t,1,b,k))}for(let t=0;t<i;t++){let p=Array(e).fill().map(()=>Array(e).fill(-1)),g=Array(e).fill().map(()=>Array(e).fill(-1));for(let r=0;r<e;r++)for(let l=0;l<e;l++){const a=this.getBlock(s,r,t,l);if(a!==-1&&a!==5){const m=this.getBlock(s,r,t+1,l);this.TRANSPARENT_BLOCKS.has(m)&&a!==m&&(p[r][l]=a);const S=this.getBlock(s,r,t-1,l);this.TRANSPARENT_BLOCKS.has(S)&&a!==S&&(g[r][l]=a)}}n.push(...this.getGreedySlice(p,1,t,0,b,k)),n.push(...this.getGreedySlice(g,1,t,1,b,k))}return this.makeGreedyMeshData(n)}getGreedySlice(u,c,e,i,o=0,A=0){let b=u.length,k=u[0].length,n=[];for(let s=0;s<b;s++)for(let t=0;t<k;t++){if(u[s][t]==-1)continue;let p=u[s][t],g=t,r=t,l=s,a=s;for(;++r<k&&u[s][r]===p;);for(;++a<b;){let m=!0;for(let S=g;S<r;S++)if(u[a][S]!==p){m=!1;break}if(!m)break}n.push(this.createRect(u,g,r,l,a,c,e,i,o,A))}return n}createRect(u,c,e,i,o,A,b,k,n=0,s=0){const t=this.idBlockTypeLookup[u[i][c]];let p,g,r;const l=e-c,a=o-i;for(let h=i;h<o;h++)for(let B=c;B<e;B++)u[h][B]=-1;let m="side";if(A===1&&(m=k===0?"top":"bottom"),A===0){const h=n+b+1-k;p=k==1?[h,i,s+c,h,i,s+e,h,o,s+e,h,o,s+c]:[h,i,s+e,h,i,s+c,h,o,s+c,h,o,s+e],g=k===0?[1,0,0]:[-1,0,0],r=[0,0,l,0,l,a,0,a]}else if(A===1){const h=b+1-k;p=k==1?[n+i,h,s+c,n+o,h,s+c,n+o,h,s+e,n+i,h,s+e]:[n+o,h,s+c,n+i,h,s+c,n+i,h,s+e,n+o,h,s+e],g=k===1?[0,-1,0]:[0,1,0],r=[0,0,a,0,a,l,0,l]}else{const h=s+b+1-k;p=k==0?[n+c,i,h,n+e,i,h,n+e,o,h,n+c,o,h]:[n+e,i,h,n+c,i,h,n+c,o,h,n+e,o,h],g=k===0?[0,0,1]:[0,0,-1],r=[0,0,l,0,l,a,0,a]}const S=[];for(let h=0;h<4;h++)S.push(...g);const R=`${t}-${m}`;return{vertices:p,normals:S,uvs:r,blockType:t,face:m,meshKey:R}}makeGreedyMeshData(u){if(u.length===0)return{};const c={};for(const i of u){const o=i.meshKey;o&&(c[o]||(c[o]=[]),c[o].push(i))}const e={};for(const[i,o]of Object.entries(c)){const A=[],b=[],k=[],n=[];let s=0;for(const t of o)!t.vertices||t.vertices.length!==12||!t.normals||t.normals.length!==12||!t.uvs||t.uvs.length!==8||(A.push(...t.vertices),b.push(...t.normals),k.push(...t.uvs),n.push(s,s+1,s+2,s,s+2,s+3),s+=4);A.length!==0&&(e[i]={positions:A,normals:b,uvs:k,indices:n})}return e}buildWaterMesh(u,c,e,i){if(u.length===0)return null;const o=[],A=[],b=[],k=[];let n=0;for(const s of u){const t=s.x+c*i+.5,p=s.y+.5,g=s.z+e*i+.5;s.isTopWater&&(o.push(t-.5,p+.425,g-.5,t+.5,p+.425,g-.5,t+.5,p+.425,g+.5,t-.5,p+.425,g+.5),A.push(0,1,0,0,1,0,0,1,0,0,1,0),b.push(0,0,1,0,1,1,0,1),k.push(n,n+1,n+2,n,n+2,n+3),n+=4)}return o.length===0?null:{positions:o,normals:A,uvs:b,indices:k}}}const y=new N;self.onmessage=function(T){const{type:u,data:c}=T.data;try{switch(u){case"initialize":y.initialize(c.blockTable,c.transparentBlocks),self.postMessage({type:"initialized",success:!0});break;case"buildMesh":const{chunkData:e,waterBlocks:i}=c,o=y.createGreedyMesh(e),A=i&&i.length>0?y.buildWaterMesh(i,e.chunkX,e.chunkZ,e.size):null;self.postMessage({type:"meshCompleted",data:{chunkId:`${e.chunkX},${e.chunkZ}`,terrainMeshData:o,waterMeshData:A}});break;default:throw new Error(`Unknown message type: ${u}`)}}catch(e){self.postMessage({type:"error",error:e.message,stack:e.stack})}}})();
