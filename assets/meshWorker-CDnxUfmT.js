(function(){"use strict";class N{constructor(){this.TRANSPARENT_BLOCKS=new Set([-1,4,5]),this.blockTable=null,this.idBlockTypeLookup={}}initialize(u,c){this.blockTable=u,this.TRANSPARENT_BLOCKS=new Set(c),this.idBlockTypeLookup={},Object.entries(u).forEach(([e,i])=>{this.idBlockTypeLookup[i.guid]=e})}getBlock(u,c,e,i){const o=`${c} ${e} ${i}`,T=u.get(o);return T===void 0?-1:T}createGreedyMesh(u){const{grid:c,size:e,height:i,chunkX:o,chunkZ:T}=u,b=o*e,k=T*e;let n=[];const s=new Map(c);for(let t=0;t<e;t++){let p=Array(i).fill().map(()=>Array(e).fill(-1)),g=Array(i).fill().map(()=>Array(e).fill(-1));for(let r=0;r<i;r++)for(let a=0;a<e;a++){const h=this.getBlock(s,t,r,a);if(h!==-1&&h!==5){let m=t===e-1?-1:this.getBlock(s,t+1,r,a);this.TRANSPARENT_BLOCKS.has(m)&&h!==m&&(p[r][a]=h),m=t===0?-1:this.getBlock(s,t-1,r,a),this.TRANSPARENT_BLOCKS.has(m)&&h!==m&&(g[r][a]=h)}}n.push(...this.getGreedySlice(p,0,t,0,b,k)),n.push(...this.getGreedySlice(g,0,t,1,b,k))}for(let t=0;t<e;t++){let p=Array(i).fill().map(()=>Array(e).fill(-1)),g=Array(i).fill().map(()=>Array(e).fill(-1));for(let r=0;r<i;r++)for(let a=0;a<e;a++){const h=this.getBlock(s,a,r,t);if(h!==-1&&h!==5){let m=t===e-1?-1:this.getBlock(s,a,r,t+1);this.TRANSPARENT_BLOCKS.has(m)&&h!==m&&(p[r][a]=h),m=t===0?-1:this.getBlock(s,a,r,t-1),this.TRANSPARENT_BLOCKS.has(m)&&h!==m&&(g[r][a]=h)}}n.push(...this.getGreedySlice(p,2,t,0,b,k)),n.push(...this.getGreedySlice(g,2,t,1,b,k))}for(let t=0;t<i;t++){let p=Array(e).fill().map(()=>Array(e).fill(-1)),g=Array(e).fill().map(()=>Array(e).fill(-1));for(let r=0;r<e;r++)for(let a=0;a<e;a++){const h=this.getBlock(s,r,t,a);if(h!==-1&&h!==5){const m=this.getBlock(s,r,t+1,a);this.TRANSPARENT_BLOCKS.has(m)&&h!==m&&(p[r][a]=h);const A=this.getBlock(s,r,t-1,a);this.TRANSPARENT_BLOCKS.has(A)&&h!==A&&(g[r][a]=h)}}n.push(...this.getGreedySlice(p,1,t,0,b,k)),n.push(...this.getGreedySlice(g,1,t,1,b,k))}return this.makeGreedyMeshData(n)}getGreedySlice(u,c,e,i,o=0,T=0){let b=u.length,k=u[0].length,n=[];for(let s=0;s<b;s++)for(let t=0;t<k;t++){if(u[s][t]==-1)continue;let p=u[s][t],g=t,r=t,a=s,h=s;for(;++r<k&&u[s][r]===p;);for(;++h<b;){let m=!0;for(let A=g;A<r;A++)if(u[h][A]!==p){m=!1;break}if(!m)break}n.push(this.createRect(u,g,r,a,h,c,e,i,o,T))}return n}createRect(u,c,e,i,o,T,b,k,n=0,s=0){const t=this.idBlockTypeLookup[u[i][c]];let p,g,r;const a=e-c,h=o-i;for(let l=i;l<o;l++)for(let S=c;S<e;S++)u[l][S]=-1;if(T===0){const l=n+b+1-k;p=k==1?[l,i,s+c,l,i,s+e,l,o,s+e,l,o,s+c]:[l,i,s+e,l,i,s+c,l,o,s+c,l,o,s+e],g=k===0?[1,0,0]:[-1,0,0],r=[0,0,a,0,a,h,0,h]}else if(T===1){const l=b+1-k;p=k==1?[n+i,l,s+c,n+o,l,s+c,n+o,l,s+e,n+i,l,s+e]:[n+o,l,s+c,n+i,l,s+c,n+i,l,s+e,n+o,l,s+e],g=k===1?[0,-1,0]:[0,1,0],r=[0,0,h,0,h,a,0,a]}else{const l=s+b+1-k;p=k==0?[n+c,i,l,n+e,i,l,n+e,o,l,n+c,o,l]:[n+e,i,l,n+c,i,l,n+c,o,l,n+e,o,l],g=k===0?[0,0,1]:[0,0,-1],r=[0,0,a,0,a,h,0,h]}const m=[];for(let l=0;l<4;l++)m.push(...g);let A=t;return t==="grass"&&T===1&&(A=k===0?"grass_top":"dirt"),{vertices:p,normals:m,uvs:r,blockType:A}}makeGreedyMeshData(u){if(u.length===0)return{};const c={};for(const i of u){const o=i.blockType;!o||!this.blockTable[o]||(c[o]||(c[o]=[]),c[o].push(i))}const e={};for(const[i,o]of Object.entries(c)){const T=[],b=[],k=[],n=[];let s=0;for(const t of o)!t.vertices||t.vertices.length!==12||!t.normals||t.normals.length!==12||!t.uvs||t.uvs.length!==8||(T.push(...t.vertices),b.push(...t.normals),k.push(...t.uvs),n.push(s,s+1,s+2,s,s+2,s+3),s+=4);T.length!==0&&(e[i]={positions:T,normals:b,uvs:k,indices:n})}return e}buildWaterMesh(u,c,e,i){if(u.length===0)return null;const o=[],T=[],b=[],k=[];let n=0;for(const s of u){const t=s.x+c*i+.5,p=s.y+.5,g=s.z+e*i+.5;s.isTopWater&&(o.push(t-.5,p+.425,g-.5,t+.5,p+.425,g-.5,t+.5,p+.425,g+.5,t-.5,p+.425,g+.5),T.push(0,1,0,0,1,0,0,1,0,0,1,0),b.push(0,0,1,0,1,1,0,1),k.push(n,n+1,n+2,n,n+2,n+3),n+=4)}return o.length===0?null:{positions:o,normals:T,uvs:b,indices:k}}}const B=new N;self.onmessage=function(y){const{type:u,data:c}=y.data;try{switch(u){case"initialize":B.initialize(c.blockTable,c.transparentBlocks),self.postMessage({type:"initialized",success:!0});break;case"buildMesh":const{chunkData:e,waterBlocks:i}=c,o=B.createGreedyMesh(e),T=i&&i.length>0?B.buildWaterMesh(i,e.chunkX,e.chunkZ,e.size):null;self.postMessage({type:"meshCompleted",data:{chunkId:`${e.chunkX},${e.chunkZ}`,terrainMeshData:o,waterMeshData:T}});break;default:throw new Error(`Unknown message type: ${u}`)}}catch(e){self.postMessage({type:"error",error:e.message,stack:e.stack})}}})();
